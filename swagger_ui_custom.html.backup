<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Royal Taxi API - Swagger UI</title>
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/swagger-ui-dist@5.9.0/swagger-ui.css" />
    <style>
        html {
            box-sizing: border-box;
            overflow: -moz-scrollbars-vertical;
            overflow-y: scroll;
        }
        *, *:before, *:after {
            box-sizing: inherit;
        }
        body {
            margin:0;
            padding:0;
        }
        .swagger-ui .topbar {
            background-color: #1e3a8a;
        }
        #auth-banner {
            background: #10b981;
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 9999;
            animation: slideDown 0.3s ease-out;
        }
        #logout-banner {
            background: #ef4444;
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 9999;
            animation: slideDown 0.3s ease-out;
        }
        @keyframes slideDown {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
        }
        #auth-status {
            position: fixed;
            top: 10px;
            right: 20px;
            z-index: 10000;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border-radius: 8px;
            padding: 12px 18px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            border: none;
            animation: authPulse 2s infinite;
        }

        #auth-status.authorized {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        #auth-status.not-authorized {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            animation: none;
        }

        @keyframes authPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        #logout-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 13px;
            transition: background 0.2s;
        }
        #logout-btn:hover {
            background: #dc2626;
        }
        #force-auth-btn:hover {
            background: #059669;
        }
        #auth-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #10b981;
        }
        #auth-indicator.not-logged-in {
            background: #ef4444;
        }
        .auth-text {
            font-size: 13px;
            font-weight: 600;
            color: #1e3a8a;
        }
    </style>
</head>

<body>
    <div id="auth-banner">‚úÖ Muvaffaqiyatli avtorizatsiya! Endi barcha himoyalangan endpointlarni ishlatishingiz mumkin.</div>
    <div id="logout-banner">üîí Tizimdan chiqdingiz. Login yoki Register qiling.</div>

    <!-- Auth Status Display -->
    <div id="auth-status" style="display: none;">
        <div id="auth-indicator"></div>
        <span class="auth-text" id="auth-status-text">Kirish yo'q</span>
        <button id="logout-btn" onclick="performLogout()">Logout</button>
        <button id="force-auth-btn" onclick="forceAuth()" style="margin-left: 10px; background: #10b981; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">Force Auth</button>
    </div>

    <div id="swagger-ui"></div>

    <script src="https://unpkg.com/swagger-ui-dist@5.9.0/swagger-ui-bundle.js"></script>
    <script src="https://unpkg.com/swagger-ui-dist@5.9.0/swagger-ui-standalone-preset.js"></script>
    <script>
        // Update auth status display
        function updateAuthStatus() {
            const storedToken = localStorage.getItem('swagger_auth_token');
            const authStatus = document.getElementById('auth-status');
            const authIndicator = document.getElementById('auth-indicator');
            const authStatusText = document.getElementById('auth-status-text');

            if (storedToken) {
                authStatus.style.display = 'flex';
                authStatus.classList.remove('not-authorized');
                authStatus.classList.add('authorized');
                authIndicator.classList.remove('not-logged-in');
                authStatusText.textContent = '‚úÖ Avtorizatsiya aktiv';
            } else {
                authStatus.style.display = 'flex';
                authStatus.classList.remove('authorized');
                authStatus.classList.add('not-authorized');
                authIndicator.classList.add('not-logged-in');
                authStatusText.textContent = '‚ùå Kirish yo\'q';
            }
        }

        // Logout function
        async function performLogout() {
            const token = localStorage.getItem('swagger_auth_token');

            // Call backend logout API if token exists
            if (token) {
                try {
                    const response = await fetch('/api/v1/auth/logout', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        console.log('‚úÖ Backend logout:', data.message);
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Backend logout xatolik:', error);
                }
            }

            // Remove tokens from localStorage
            localStorage.removeItem('swagger_auth_token');
            localStorage.removeItem('authorized');  // Swagger's internal authorization

            // Clear Swagger UI authorization
            if (window.ui && window.ui.authActions) {
                window.ui.authActions.logout(['Bearer']);
            }

            // Show logout banner
            const logoutBanner = document.getElementById('logout-banner');
            logoutBanner.style.display = 'block';
            setTimeout(() => {
                logoutBanner.style.display = 'none';
            }, 4000);

            // Update status
            updateAuthStatus();

            console.log('üîì Token va Swagger authorization o\'chirildi');

            // Reload page to clear authorization
            setTimeout(() => {
                location.reload();
            }, 1500);
        }

        window.onload = function() {
            // Update auth status on page load
            updateAuthStatus();

            // Initialize Swagger UI
            const ui = SwaggerUIBundle({
                url: "/openapi.json",
                dom_id: '#swagger-ui',
                deepLinking: true,
                presets: [
                    SwaggerUIBundle.presets.apis,
                    SwaggerUIStandalonePreset
                ],
                plugins: [
                    SwaggerUIBundle.plugins.DownloadUrl
                ],
                layout: "StandaloneLayout",
                persistAuthorization: true,
                displayRequestDuration: true,
                filter: true,
                tryItOutEnabled: true,
                syntaxHighlight: {
                    theme: "monokai"
                },
                // Pre-authorize with stored token
                ...(() => {
                    const storedToken = localStorage.getItem('swagger_auth_token');
                    if (storedToken) {
                        return {
                            authorizations: {
                                Bearer: {
                                    name: 'Bearer',
                                    schema: {
                                        type: 'http',
                                        scheme: 'bearer',
                                        bearerFormat: 'JWT'
                                    },
                                    value: storedToken
                                }
                            }
                        };
                    }
                    return {};
                })(),
                requestInterceptor: (request) => {
                    // Always add the stored token if it exists (except for auth endpoints)
                    const storedAuth = localStorage.getItem('swagger_auth_token');
                    const isAuthEndpoint = request.url.indexOf('/auth/login') !== -1 || request.url.indexOf('/auth/register') !== -1;

                    if (storedAuth && !isAuthEndpoint) {
                        // Ensure headers object exists
                        request.headers = request.headers || {};
                        const authValue = `Bearer ${storedAuth}`;
                        // Prefer Headers.set API when available
                        if (request.headers && typeof request.headers.set === 'function') {
                            try {
                                request.headers.set('Authorization', authValue);
                                request.headers.set('authorization', authValue);
                            } catch (e) {
                                // Fallback to plain object assignment
                                request.headers['Authorization'] = authValue;
                                request.headers['authorization'] = authValue;
                            }
                        } else {
                            // Plain object fallback
                            request.headers['Authorization'] = authValue;
                            request.headers['authorization'] = authValue;
                        }

                        console.log('üì§ Request URL:', request.url);
                        console.log('üîë Authorization:', request.headers['Authorization'] ? 'SET ‚úÖ' : 'NOT SET ‚ùå');
                        console.log('   Token:', storedAuth.substring(0, 30) + '...');
                    } else if (!storedAuth && !isAuthEndpoint) {
                        console.warn('‚ö†Ô∏è NO TOKEN - Request:', request.url, '- 401 expected');
                    }

                    // Ensure cookies are sent for same-origin requests
                    try { request.credentials = 'same-origin'; } catch (e) {}
                    return request;
                },
                responseInterceptor: (response) => {
                    // Check if this is a login or register response
                    const isAuthEndpoint = response.url.includes('/auth/login') || response.url.includes('/auth/register');

                    if (isAuthEndpoint && (response.status === 200 || response.status === 201)) {
                                console.log('üéØ AUTH ENDPOINT DETECTED!');
                                console.log('üì° URL:', response.url);
                                console.log('üìä Status:', response.status);
                                console.log('üîë Token extracted successfully');
                                console.log('üöÄ Starting automatic authorization...');
                        try {
                            // swagger-ui provides parsed data on response.data
                            let data = response && (response.data || response.obj);
                            // Fallback: try to parse text if needed
                            if (!data && response && typeof response.text === 'string' && response.text.trim().length > 0) {
                                try { data = JSON.parse(response.text); } catch (e) { /* ignore */ }
                            }

                            if (data && (data.access_token || data.token || data.accessToken)) {
                                const token = data.access_token || data.token || data.accessToken;

                                // Store token in localStorage (will persist until logout)
                                localStorage.setItem('swagger_auth_token', token);

                                // Show auth banner
                                const authBanner = document.getElementById('auth-banner');
                                const isRegister = response.url.includes('/auth/register');
                                authBanner.innerHTML = `
                                    <div style="font-size: 16px; font-weight: bold; margin-bottom: 5px;">
                                        üîê AVTOMATIK AVTORIZATSIYA!
                                    </div>
                                    <div style="font-size: 14px;">
                                        ${isRegister ? 'Ro\'yxatdan o\'tish' : 'Kirish'} muvaffaqiyatli! Barcha API lar endi ishlaydi.
                                    </div>
                                    <div style="font-size: 12px; margin-top: 5px; color: #10b981;">
                                        ‚úã "Authorize" tugmasini bosish shart emas!
                                    </div>
                                `;
                                authBanner.style.display = 'block';
                                authBanner.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                                authBanner.style.border = 'none';
                                authBanner.style.borderRadius = '8px';
                                authBanner.style.padding = '15px';
                                authBanner.style.color = 'white';
                                authBanner.style.textAlign = 'center';
                                authBanner.style.boxShadow = '0 4px 12px rgba(16, 185, 129, 0.3)';
                                setTimeout(() => {
                                    authBanner.style.display = 'none';
                                }, 5000);

                                // Authorize Swagger UI IMMEDIATELY with multiple methods
                                setTimeout(() => {
                                    // Method 1: Set localStorage for persistence
                                    const authorized = {
                                        Bearer: {
                                            name: 'Bearer',
                                            schema: {
                                                type: 'http',
                                                scheme: 'bearer',
                                                bearerFormat: 'JWT'
                                            },
                                            value: token
                                        }
                                    };
                                    localStorage.setItem('authorized', JSON.stringify(authorized));
                                    console.log('‚úÖ localStorage set for persistence');

                                    // Method 2: Direct authorization using authActions
                                    if (window.ui && window.ui.authActions) {
                                        try {
                                            window.ui.authActions.authorize(authorized);
                                            console.log('‚úÖ authActions.authorize() called');
                                        } catch (e) {
                                            console.warn('‚ö†Ô∏è authActions.authorize() failed:', e.message);
                                        }
                                    }
                                    // Method 3: Force UI update
                                    updateAuthStatus();

                                    console.log('‚úÖ Immediate authorization completed');
                                    console.log('üéâ You can now use all APIs without manual authorization!');
                                    console.log('üí° Try any protected endpoint - it should work automatically');
                                    console.log('='.repeat(60));
                                    console.log('‚ÑπÔ∏è 401 UNAUTHORIZED ERROR DEBUGGING');
                                    console.log('='.repeat(60));
                                    console.log('   URL:', response.url);
                                    console.log('   Token:', storedToken ? storedToken.substring(0, 30) + '...' : 'NO TOKEN');
                                    console.log('   Swagger authorized:', swaggerAuth ? 'YES ‚úÖ' : 'NO ‚ùå');
                                    console.log('='.repeat(60));
                                } catch (error) {
                                    console.warn('‚ö†Ô∏è Token extraction failed:', error);
                                }
                            }

                            // Handle 401 errors with detailed debugging
                            if (response.status === 401) {
                                console.error('='.repeat(60));
                                console.error('‚ùå 401 UNAUTHORIZED ERROR!');
                                console.error('URL:', response.url);
                    if (response.status === 401) {
                        console.error('='.repeat(60));
                        console.error('‚ùå 401 UNAUTHORIZED ERROR!');
                        console.error('URL:', response.url);

                        const storedToken = localStorage.getItem('swagger_auth_token');
                        const swaggerAuth = localStorage.getItem('authorized');

                        console.error('Token in localStorage:', storedToken ? 'YES ‚úÖ' : 'NO ‚ùå');
                        console.error('Swagger authorized:', swaggerAuth ? 'YES ‚úÖ' : 'NO ‚ùå');

                        if (!storedToken) {
                            console.error('‚û°Ô∏è YECHIM: Login yoki Register qiling!');
                        } else {
                            console.error('‚û°Ô∏è Token BOR lekin 401 chiqdi!');
                            console.error('   Token:', storedToken.substring(0, 30) + '...');
                            console.error('   YECHIM: Sahifani yangilang yoki qayta login qiling');
                        }

                        console.error('='.repeat(60));
                    }
                    return response;
                }
            });

            // Function to authorize Swagger UI with token - Swagger UI 5.x compatible
            function authorizeSwaggerUI(token) {
                if (!token || !ui) return;

                console.log('üîê Authorizing Swagger UI 5.x with token...');

                try {
                    // Method 1: Use authActions.authorize (primary method for Swagger UI 5.x)
                    if (ui.authActions && ui.authActions.authorize) {
                        const authConfig = {
                            Bearer: {
                                name: 'Bearer',
                                schema: {
                                    type: 'http',
                                    scheme: 'bearer',
                                    bearerFormat: 'JWT'
                                },
                                value: token
                            }
                        };

                        ui.authActions.authorize(authConfig);
                        console.log('‚úÖ Method 1 (authActions.authorize): SUCCESS');
                    } else {
                        console.warn('‚ö†Ô∏è authActions.authorize not available');
                    }

                    // Method 2: Set authorization in localStorage for persistence
                    const authorized = {
                        Bearer: {
                            name: 'Bearer',
                            schema: {
                                type: 'http',
                                scheme: 'bearer',
                                bearerFormat: 'JWT'
                            },
                            value: token
                        }
                    };
                    localStorage.setItem('authorized', JSON.stringify(authorized));
                    console.log('‚úÖ Method 2 (localStorage): SUCCESS');

                    // Method 3: Force update UI state if possible
                    if (ui.getState && ui.getState().get) {
                        try {
                            const currentState = ui.getState().get('authorized');
                            if (currentState !== authorized) {
                                console.log('üîÑ Updating UI state...');
                            }
                        } catch (e) {
                            // Ignore state update errors
                        }
                    }

                    console.log('‚úÖ Swagger UI 5.x authorization completed');

                    // Update our status display
                    updateAuthStatus();

                } catch (error) {
                    console.error('‚ùå Authorization failed:', error);
                }
            }

            // Check for stored token on page load and restore authorization
            const storedToken = localStorage.getItem('swagger_auth_token');
            if (storedToken) {
                setTimeout(() => {
                    authorizeSwaggerUI(storedToken);
                    console.log('‚úÖ Avvalgi session qayta tiklandi');
                    console.log('üí° Token saqlanib qolgan, 401 error bo\'lmaydi');
                }, 1500);
            } else {
                console.log('‚ÑπÔ∏è Token yo\'q. Login yoki Register qiling.');
            }

            window.ui = ui;
            window.authorizeSwaggerUI = authorizeSwaggerUI;

            // Add event listener for authorization modal
            document.addEventListener('click', function(e) {
                // Check if authorization button was clicked
                if (e.target.matches('[data-swagger-ui="auth-btn"]') ||
                    e.target.closest('[data-swagger-ui="auth-btn"]') ||
                    e.target.matches('.authorization__btn') ||
                    e.target.closest('.authorization__btn')) {

                    console.log('üîì Authorization button clicked - ensuring token is set');

                    setTimeout(() => {
                        const storedToken = localStorage.getItem('swagger_auth_token');
                        if (storedToken && window.ui && window.ui.authActions) {
                            try {
                                const authorized = {
                                    Bearer: {
                                        name: 'Bearer',
                                        schema: {
                                            type: 'http',
                                            scheme: 'bearer',
                                            bearerFormat: 'JWT'
                                        },
                                        value: storedToken
                                    }
                                };
                                window.ui.authActions.authorize(authorized);
                                console.log('‚úÖ Authorization modal updated with token');
                            } catch (error) {
                                console.warn('‚ö†Ô∏è Could not update authorization modal:', error);
                            }
                        }
                    }, 500);
                }
            });
        };

        // Make functions available globally
        window.performLogout = performLogout;

        // Helper functions for debugging
        window.checkAuth = function() {
            const token = localStorage.getItem('swagger_auth_token');
            const swaggerAuth = localStorage.getItem('authorized');

            console.log('='.repeat(60));
            console.log('üîç AUTH STATUS CHECK');
            console.log('='.repeat(60));
            console.log('Token saved:', token ? 'YES ‚úÖ' : 'NO ‚ùå');
            if (token) {
                console.log('Token:', token.substring(0, 50) + '...');
                console.log('Token length:', token.length);
            }
            console.log('Swagger authorized:', swaggerAuth ? 'YES ‚úÖ' : 'NO ‚ùå');
            if (swaggerAuth) {
                try {
                    const auth = JSON.parse(swaggerAuth);
                    console.log('Swagger auth data:', auth);
                } catch(e) {
                    console.log('Cannot parse swagger auth');
                }
            }
            console.log('='.repeat(60));
        };

        window.forceAuth = function() {
            const token = localStorage.getItem('swagger_auth_token');
            if (!token) {
                console.error('‚ùå Token yo\'q! Login qiling.');
                return;
            }
            console.log('üîÑ Forcing authorization...');
            authorizeSwaggerUI(token);
            console.log('‚úÖ Done! Endi endpoint ni sinab ko\'ring.');
        };

        window.manualAuth = function(token) {
            if (!token) {
                console.error('‚ùå Token berilmadi!');
                return;
            }
            console.log('üîÑ Manual authorization with provided token...');
            localStorage.setItem('swagger_auth_token', token);
            authorizeSwaggerUI(token);
            updateAuthStatus();
            console.log('‚úÖ Manual authorization completed!');
        };

        window.testAuth = function() {
            const token = localStorage.getItem('swagger_auth_token');
            if (!token) {
                console.error('‚ùå Token yo\'q! Login qiling.');
                return;
            }

            console.log('üß™ Testing authorization with a simple API call...');

            fetch('/api/v1/users/balance', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (response.ok) {
                    console.log('‚úÖ Authorization WORKS! API call successful.');
                    return response.json();
                } else if (response.status === 401) {
                    console.error('‚ùå Authorization FAILED! 401 error returned.');
                    console.log('üîÑ Trying to re-authorize...');
                    forceAuth();
                    return null;
                } else {
                    console.warn(`‚ö†Ô∏è Unexpected response: ${response.status}`);
                    return null;
                }
            })
            .then(data => {
                if (data) {
                    console.log('üìä Balance data:', data);
                }
            })
            .catch(error => {
                console.error('‚ùå API call failed:', error);
            });
        };

        console.log('='.repeat(60));
        console.log('üöï Royal Taxi API - Swagger UI');
        console.log('='.repeat(60));
        console.log('üìù Qanday ishlaydi:');
        console.log('1. Login YOKI Register qiling');
        console.log('2. Token avtomatik saqlanadi va Authorize qilinadi');
        console.log('3. Sahifani yangilasangiz ham token saqlanadi');
        console.log('4. Logout tugmasini bosing yoki performLogout() chaqiring');
        console.log('='.repeat(60));
        console.log('üõ†Ô∏è Debug funksiyalari:');
        console.log('   checkAuth()     - Auth statusni ko\'rish');
        console.log('   forceAuth()     - Token ni qayta authorize qilish');
        console.log('   testAuth()      - Authorization ni test qilish');
        console.log('   manualAuth(token) - Berilgan token bilan authorize qilish');
        console.log('   performLogout() - Logout qilish');
        console.log('='.repeat(60));
    </script>
</body>
</html>
